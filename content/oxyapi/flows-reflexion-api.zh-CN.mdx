---
title: Reflexion API 参考
description: Reflexion 流程的完整 API 参考文档，包括构造函数参数和自我评估方法
icon: Code
---

## 类概述

```python
from oxygent.oxy.flows import Reflexion, MathReflexion

# Basic Reflexion
reflexion_flow = Reflexion(
    name="quality_improver",
    desc="通过自我评估迭代改进答案质量",
    worker_agent="worker_agent",
    reflexion_agent="reflexion_agent",
    max_reflexion_rounds=3
)

# Math-specialized Reflexion
math_flow = MathReflexion(
    name="math_solver",
    desc="专门用于数学问题的反思流程",
    max_reflexion_rounds=3
)
```

## 构造函数参数

### 核心参数

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `name` | str | 必需 | Reflexion 流程的唯一标识符 |
| `worker_agent` | str | "worker_agent" | 生成答案的工作者代理的名称 |
| `reflexion_agent` | str | "reflexion_agent" | 评估答案的代理的名称 |
| `max_reflexion_rounds` | int | 3 | 最大改进迭代次数 |

### 解析参数

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `func_parse_worker_response` | Callable | None | 自定义工作者响应解析器 |
| `func_parse_reflexion_response` | Callable | None | 自定义反思响应解析器 |
| `pydantic_parser_reflexion` | PydanticOutputParser | ReflectionEvaluation parser | 结构化评估解析器 |

### 模板参数

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `evaluation_template` | str | 默认模板 | 评估提示的模板 |
| `improvement_template` | str | 默认模板 | 改进提示的模板 |

### 可选参数

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `desc` | str | "" | 流程用途的描述 |
| `timeout` | int | 100 | 最大执行时间（秒） |
| `llm_model` | str | "default_llm" | 用于后备操作的 LLM 模型 |
| `is_permission_required` | bool | False | 是否需要权限 |
| `is_master` | bool | False | 是否为主入口点 |

## 参数详情

### `worker_agent`
- **Type**: `str`
- **默认**: `"worker_agent"`
- **描述**: 生成待评估答案的代理名称。

**要求:**
- 必须在同一多智能体系统中注册
- 应该产生有意义的答案
- 可以是任何代理类型 (ChatAgent, ReActAgent, 等)

**Example:**
```python
Reflexion(
    name="improver",
    worker_agent="content_writer",  # 自定义工作者
    reflexion_agent="quality_checker"
)
```

### `reflexion_agent`
- **Type**: `str`
- **默认**: `"reflexion_agent"`
- **描述**: 评估答案质量并提供改进建议的代理名称。

**要求:**
- 必须在同一多智能体系统中注册
- 应该理解评估标准
- 应该提供建设性反馈

**Example:**
```python
Reflexion(
    name="improver",
    worker_agent="writer",
    reflexion_agent="editor_agent"  # 自定义评估器
)
```

### `max_reflexion_rounds`
- **Type**: `int`
- **默认**: `3`
- **描述**: 返回最终答案前的最大改进迭代次数。

**使用指南:**
- 快速改进: 1-2 轮
- 标准质量: 3-5 轮
- 高精度: 5-10 轮

**Example:**
```python
Reflexion(
    name="high_quality",
    max_reflexion_rounds=5,  # 更多迭代以提高质量
    ...
)
```

### `evaluation_template`
- **Type**: `str`
- **默认**: 质量评估模板
- **描述**: 评估提示的模板字符串。变量: `{query}`, `{answer}`

**默认 Template:**
```python
"""Please evaluate the quality of the following answer:

Original Question: {query}

Answer: {answer}

Please evaluate based on these criteria:
1. 准确性: 信息是否正确且基于事实?
2. 完整性: 是否完全回答了用户的问题?
3. 清晰度: 是否结构良好且易于理解?
4. 相关性: 是否专注于用户的需求?
5. 有用性: 是否为用户提供了实用价值?

Return your evaluation in the following format:
- is_satisfactory: true/false
- evaluation_reason: [Detailed explanation]
- improvement_suggestions: [Specific recommendations if unsatisfactory]"""
```

**Custom Example:**
```python
custom_template = """Evaluate this technical answer:

Question: {query}
Answer: {answer}

Check:
1. Technical accuracy
2. Code correctness
3. Best practices followed

Format:
- is_satisfactory: true/false
- evaluation_reason: [Why?]
- improvement_suggestions: [How to improve?]"""

Reflexion(
    name="tech_reviewer",
    evaluation_template=custom_template,
    ...
)
```

### `improvement_template`
- **Type**: `str`
- **默认**: 改进提示模板
- **描述**: 改进提示的模板。变量: `{original_query}`, `{improvement_suggestions}`, `{previous_answer}`

**默认 Template:**
```python
"""{original_query}

Please improve your previous answer based on the following feedback:
{improvement_suggestions}

Previous answer: {previous_answer}"""
```

**Custom Example:**
```python
Reflexion(
    name="improver",
    improvement_template="""Original task: {original_query}

Your previous attempt needs improvement:
{previous_answer}

Feedback: {improvement_suggestions}

Please provide an improved version.""",
    ...
)
```

### `pydantic_parser_reflexion`
- **Type**: `PydanticOutputParser`
- **默认**: `PydanticOutputParser(output_cls=ReflectionEvaluation)`
- **描述**: 结构化评估结果的解析器。

**默认 ReflectionEvaluation Model:**
```python
class ReflectionEvaluation(BaseModel):
    is_satisfactory: bool = Field(description="答案是否令人满意")
    evaluation_reason: str = Field(description="评估的详细说明")
    improvement_suggestions: str = Field(
        default="", description="如果不满意的具体改进建议"
    )
```

## ReflectionEvaluation Model

### Fields

|Field|类型|必需|描述|
|-------|------|----------|-------------|
| `is_satisfactory` | bool | 是 | 答案是否满足质量标准 |
| `evaluation_reason` | str | 是 | 评估的详细说明 |
| `improvement_suggestions` | str | 否 | 具体的改进建议 |

**Example:**
```python
evaluation = ReflectionEvaluation(
    is_satisfactory=False,
    evaluation_reason="Answer lacks specific examples and technical details",
    improvement_suggestions="Add code examples and explain the technical trade-offs"
)
```

## 方法

### `_execute(oxy_request: OxyRequest) -> OxyResponse`

**内部方法** - 编排反思工作流程。

**执行流程:**
1. **初始答案**: 调用工作者代理处理原始查询
2. **评估循环** (最多 max_reflexion_rounds 轮):
   - 解析工作者响应
   - 格式化评估查询
   - 调用反思代理
   - 解析评估结果
   - 如果满意: 返回最终答案
   - 如果不满意: 更新查询包含改进建议，重复
3. **最大轮数回退**: 使用 LLM 生成最终答案

**注意:** 内部方法 - 请使用 `mas.call()` 或 `oxy_request.call()` 代替。

## MathReflexion Class

专门用于数学问题的 Reflexion 子类。

### 构造函数

```python
MathReflexion(
    name="math_solver",
    desc="专门用于数学的反思流程",
    worker_agent="math_expert_agent",  # 可选，默认为 "math_expert_agent"
    reflexion_agent="math_checker_agent",  # 可选，默认为 "math_checker_agent"
    max_reflexion_rounds=3
)
```

### 与基础 Reflexion 的区别

1. **默认代理**: 使用数学专用的代理名称
2. **数学评估模板**: 专门用于数学正确性评估
3. **逐步聚焦**: 强调显示计算步骤

**默认 Math Evaluation Template:**
```python
"""Please check the correctness and completeness of the following mathematical solution:

Problem: {query}

Solution: {answer}

Check points:
1. 计算步骤是否正确?
2. 是否有遗漏的步骤?
3. 最终答案是否清晰?
4. 解题方法是否清晰?
5. 数学公式和定理应用是否正确?

Return your evaluation in the following format:
- is_satisfactory: true/false (use true for Pass, false for Fail)
- evaluation_reason: [Detailed explanation of the check]
- improvement_suggestions: [Specific correction suggestions if failed]"""
```

## Usage 示例s

### Basic Reflexion

```python
from oxygent import MAS, oxy

oxy_space = [
    oxy.HttpLLM(name="default_llm", ...),
    oxy.ChatAgent(
        name="worker_agent",
        prompt="你是一个有用的助手"
    ),
    oxy.ChatAgent(
        name="reflexion_agent",
        prompt="你是一个质量评估器"
    ),
    oxy.flows.Reflexion(
        name="quality_flow",
        worker_agent="worker_agent",
        reflexion_agent="reflexion_agent",
        max_reflexion_rounds=3
    )
]

async def main():
    async with MAS(oxy_space=oxy_space) as mas:
        result = await mas.call(
            callee="quality_flow",
            arguments={"query": "Explain quantum computing"}
        )
        print(result.output)
        print(result.extra)  # 包含反思元数据
```

### Math Reflexion

```python
oxy.flows.MathReflexion(
    name="math_solver",
    desc="解决和验证数学问题",
    max_reflexion_rounds=5  # 复杂数学问题需要更多轮次
)
```

### Custom Evaluation Criteria

```python
oxy.flows.Reflexion(
    name="code_reviewer",
    evaluation_template="""Review this code answer:

Question: {query}
Code: {answer}

Evaluate:
1. Code correctness
2. Best practices
3. Performance
4. Security

Return:
- is_satisfactory: true/false
- evaluation_reason: [Analysis]
- improvement_suggestions: [Specific fixes]""",
    worker_agent="coder_agent",
    reflexion_agent="reviewer_agent"
)
```

## 执行流程 Diagram

```
User Query
    ↓
┌─── Reflexion Loop (max_reflexion_rounds) ───┐
│                                              │
│  worker_agent generates answer               │
│    ↓                                         │
│  Parse worker response                       │
│    ↓                                         │
│  Format evaluation query (evaluation_template) │
│    ↓                                         │
│  reflexion_agent evaluates quality           │
│    ↓                                         │
│  Parse evaluation (ReflectionEvaluation)     │
│    ↓                                         │
│  is_satisfactory = true?                     │
│    ├─Yes→ Return final answer ✅             │
│    └─No─→ Format improvement query           │
│           (improvement_template)             │
│           Update current_query               │
│           Continue loop ↻                    │
│                                              │
└──────────────────────────────────────────────┘
    ↓
如果达到最大轮数:
  使用 LLM 生成最终答案
    ↓
OxyResponse(
  output=final answer,
  extra={
    reflexion_rounds: N,
    final_evaluation: {...},
    reached_max_rounds: true/false
  }
)
```

## Return Value

### OxyResponse Structure

```python
{
    "state": OxyState.COMPLETED,
    "output": "Final answer optimized through N rounds of reflexion:\n\n[answer]",
    "extra": {
        "reflexion_rounds": 3,  # 执行的轮数
        "final_evaluation": {
            "is_satisfactory": true,
            "evaluation_reason": "...",
            "improvement_suggestions": "..."
        },
        "reached_max_rounds": false  # 如果因达到最大轮数而停止则为 True
    }
}
```

## 最佳实践

### 1. 选择合适的评估器

```python
# ✅ 好: 专业评估器
oxy.ChatAgent(
    name="evaluator",
    llm_model="gpt-4",  # 强大的评估能力
    prompt="你是一个专家编辑。严格评估答案质量。"
)

# ⚠️ 注意: 工作者和评估器使用相同模型可能缺乏批判距离
```

### 2. 设置合理的最大轮数

```python
# 快速改进
Reflexion(name="quick", max_reflexion_rounds=2, ...)

# 高质量输出
Reflexion(name="quality", max_reflexion_rounds=5, ...)

# 数学精度
MathReflexion(name="math", max_reflexion_rounds=7, ...)
```

### 3. 提供清晰的评估标准

```python
# ✅ 好: 具体、可衡量的标准
evaluation_template="""基于以下标准评估:
1. 事实准确性 (验证声明)
2. 完整性 (涵盖所有方面)
3. 清晰度 (易于理解的语言)
..."""

# ❌ 差: 模糊的标准
evaluation_template="这个答案好吗? 是/否"
```

### 4. 使用具体的改进建议

确保反思代理提供可操作的反馈:

```python
# ✅ 好
improvement_suggestions="在第2节添加具体示例。澄清技术术语。包含性能比较。"

# ❌ 差
improvement_suggestions="让它更好。"
```

## 常见模式

### 模式: 内容质量改进

```python
Reflexion(
    name="content_improver",
    worker_agent="content_writer",
    reflexion_agent="editor",
    max_reflexion_rounds=4
)
```

### 模式: 代码审查

```python
Reflexion(
    name="code_reviewer",
    worker_agent="code_generator",
    reflexion_agent="code_critic",
    evaluation_template=code_review_template,
    max_reflexion_rounds=3
)
```

### 模式: 数学验证

```python
MathReflexion(
    name="math_verifier",
    max_reflexion_rounds=5
)
```

## 与其他流程的比较

|特性|Reflexion|Workflow|PlanAndSolve|
|---------|-----------|----------|--------------|
| **自我评估** | 是 | 可选 | 否 |
| **迭代** | 质量驱动 | 自定义 | 步骤驱动 |
| **改进** | 自动 | 手动 | 不适用 |
| **用例** | 质量改进 | 自定义逻辑 | 多步骤任务 |

## Related API 参考

- [Workflow API](/oxyapi/flows-workflow-api) - 自定义工作流 API
- [ParallelFlow API](/oxyapi/flows-parallel-api) - 并行执行流 API
- [PlanAndSolve API](/oxyapi/flows-plan-and-solve-api) - 计划执行流 API
- [ChatAgent API](/oxyapi/agents-chat-api) - 工作者和评估者代理 API
- [ReActAgent API](/oxyapi/agents-react-api) - 高级工作者代理 API
