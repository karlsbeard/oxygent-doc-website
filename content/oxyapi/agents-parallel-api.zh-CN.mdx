---
title: ParallelAgent API 参考
description: ParallelAgent 类的完整 API 参考文档，包括构造函数参数、方法和并行执行模式
icon: Users
---

## 类概述

```python
from oxygent.oxy import ParallelAgent

class ParallelAgent(LocalAgent):
    """跨多个团队成员并行执行任务的代理。

    此代理将相同任务同时分发给所有可用的团队成员
    并合并他们的响应。
    """
```

ParallelAgent 继承自 `LocalAgent`，专门为并行任务执行而设计。它将请求分发给多个团队成员（工具或子代理），收集所有响应，然后使用 LLM 将结果合并为统一的答案。

## 构造函数

### ParallelAgent()

```python
ParallelAgent(
    name: str,
    desc: str,
    llm_model: str,
    permitted_tool_name_list: list,
    **kwargs
)
```

#### 参数

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `name` | `str` | 必需 | 用于标识和调用的代理名称 |
| `desc` | `str` | 必需 | 解释代理功能的描述 |
| `llm_model` | `str` | 必需 | 用于合并并行结果的语言模型标识符 |
| `permitted_tool_name_list` | `list` | 必需 | 要并行执行的工具/代理名称列表 |

#### 继承参数（来自 LocalAgent）

ParallelAgent 继承所有 LocalAgent 参数，但通常不需要以下参数，因为它专注于并行执行：

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `prompt` | `可选[str]` | 自动生成 | 系统提示（自动生成用于结果合并） |
| `sub_agents` | `可选[list]` | `[]` | 子代理列表（通过 permitted_tool_name_list 管理） |
| `tools` | `可选[list]` | `[]` | 工具列表（通过 permitted_tool_name_list 管理） |
| `short_memory_size` | `int` | 配置默认值 | 短期内存大小 |
| `team_size` | `int` | `1` | 团队大小（ParallelAgent 自己管理并行性） |

#### 重要说明

ParallelAgent **不添加新的数据类字段** - 它继承 LocalAgent 的所有参数。关键区别在于执行逻辑：
- 常规 LocalAgent：顺序工具执行
- ParallelAgent：并行执行 `permitted_tool_name_list` 中的所有工具

## 方法

### _execute()

```python
async def _execute(self, oxy_request: OxyRequest) -> OxyResponse
```

跨所有团队成员并行执行请求。

#### 参数

|参数|类型|描述|
|-----------|------|-------------|
| `oxy_request` | `OxyRequest` | 要跨所有团队成员执行的请求 |

#### 返回值

|类型|描述|
|------|-------------|
| `OxyResponse` | 包含所有团队成员编号结果的合并响应 |

#### 执行流程

1. **生成并行 ID**：创建唯一的并行执行标识符
2. **并行分发**：使用 `asyncio.gather()` 同时向 `permitted_tool_name_list` 中的所有工具发送请求
3. **收集响应**：等待所有并行任务完成
4. **构建合并提示**：创建包含用户问题和所有并行结果的提示
5. **LLM 合并**：使用配置的 LLM 将并行结果合并为统一答案
6. **返回结果**：返回合并后的最终响应

#### 并行执行特性

- **真正的并行**：所有任务同时执行，而非顺序执行
- **结果编号**：每个团队成员的结果都有编号（1、2、3...）
- **自动合并**：LLM 自动分析并合并所有并行结果
- **容错性**：单个团队成员失败不会影响其他成员

### 继承方法

ParallelAgent 继承所有 LocalAgent 方法，但覆盖核心执行逻辑：

#### 来自 LocalAgent

- `init()` - 初始化代理和工具列表
- `_get_history()` - 检索对话历史
- `_build_instruction()` - 构建指令提示
- `_pre_process()` - 预处理请求
- `_before_execute()` - 预执行准备

#### 来自 BaseAgent

- `_pre_save_data()` - 保存追踪数据

#### 来自 BaseFlow

- `call()` - 执行代理
- `add_permitted_tool()` - 添加允许的工具
- `set_mas()` - 设置 MAS 引用

## 使用示例

### 基础用法实例

```python
from oxygent import MAS
from oxygent.oxy import ParallelAgent, ChatAgent, HttpLLM

oxy_space = [
    HttpLLM(
        name="default_llm",
        api_key="your-api-key",
        base_url="https://api.openai.com/v1",
        model_name="gpt-3.5-turbo"
    ),

    # 专家代理
    ChatAgent(
        name="tech_expert",
        desc="Technical expert",
        llm_model="default_llm",
        prompt="You are a technical expert..."
    ),
    ChatAgent(
        name="business_expert",
        desc="Business expert",
        llm_model="default_llm",
        prompt="You are a business expert..."
    ),
    ChatAgent(
        name="risk_expert",
        desc="Risk expert",
        llm_model="default_llm",
        prompt="You are a risk expert..."
    ),

    # 协调所有专家的并行代理
    ParallelAgent(
        name="expert_panel",
        desc="Expert panel for parallel analysis",
        llm_model="default_llm",
        permitted_tool_name_list=[
            "tech_expert", "business_expert", "risk_expert"
        ],
        is_master=True
    )
]

async def main():
    async with MAS(oxy_space=oxy_space) as mas:
        result = await mas.call(
            callee="expert_panel",
            arguments={"query": "Evaluate the feasibility of this AI project"}
        )
        print(result.output)
```

### 多工具并行执行实例

```python
from oxygent.oxy import FunctionTool

# 创建多个功能工具
def analyze_market(query: str) -> str:
    """Market analysis tool"""
    return f"Market analysis result: {query}"

def analyze_technology(query: str) -> str:
    """Technology analysis tool"""
    return f"Technology analysis result: {query}"

def analyze_finance(query: str) -> str:
    """Financial analysis tool"""
    return f"Financial analysis result: {query}"

oxy_space = [
    HttpLLM(name="default_llm", ...),

    FunctionTool(name="market_tool", func=analyze_market),
    FunctionTool(name="tech_tool", func=analyze_technology),
    FunctionTool(name="finance_tool", func=analyze_finance),

    # 并行执行所有分析工具
    ParallelAgent(
        name="analysis_agent",
        desc="Parallel analysis agent",
        llm_model="default_llm",
        permitted_tool_name_list=[
            "market_tool", "tech_tool", "finance_tool"
        ]
    )
]
```

### 混合代理和工具实例

```python
oxy_space = [
    HttpLLM(name="default_llm", ...),

    # 代理
    ChatAgent(name="expert_agent", ...),
    ReActAgent(name="reasoning_agent", ...),

    # 工具
    FunctionTool(name="search_tool", ...),
    MCPTool(name="calculator", ...),

    # 混合类型的并行执行
    ParallelAgent(
        name="hybrid_agent",
        desc="Hybrid parallel execution",
        llm_model="default_llm",
        permitted_tool_name_list=[
            "expert_agent", "reasoning_agent",
            "search_tool", "calculator"
        ]
    )
]
```

## 配置选项

### 并行执行配置

- `permitted_tool_name_list`: 要并行执行的工具/代理列表
- `llm_model`: 用于结果合并的语言模型

### 结果合并配置

ParallelAgent 自动生成以下格式的合并提示：

```
You are a helpful assistant, the user's question is: {user_question}.
Please summarize the results of the parallel execution of the above tasks.

The parallel results are as following:
1. {first_result}
2. {second_result}
3. {third_result}
...
```

### 内存管理

- `short_memory_size`: 影响结果合并时的上下文长度
- 建议使用较小的值，因为并行结果已包含丰富信息

## 性能特征

### 并行执行优势

1. **时间效率**：所有任务同时执行，总时间等于最慢任务的时间
2. **资源利用**：充分利用系统并发能力
3. **结果多样性**：从多个角度获得分析结果

### 性能考虑

1. **并发限制**：受系统并发能力和 LLM API 限制影响
2. **内存使用**：同时处理多个请求会增加内存消耗
3. **合并成本**：LLM 合并步骤会增加额外的 API 调用

### 最佳实践

1. **合理数量**：建议 3-10 个并行任务
2. **任务平衡**：确保并行任务的执行时间相对平衡
3. **错误处理**：为部分任务失败设计容错机制

## 错误处理

### 常见错误

1. **工具列表为空**
   ```python
   # 错误：未指定并行工具
   ParallelAgent(
       name="agent",
       desc="test",
       llm_model="default_llm",
       permitted_tool_name_list=[]  # 空列表
   )
   ```

2. **工具未找到**
   ```python
   # 确保所有工具都已注册
   ParallelAgent(
       permitted_tool_name_list=["tool1", "tool2"],  # 确保 tool1, tool2 存在
   )
   ```

3. **LLM 模型未配置**
   ```python
   # 确保 LLM 已注册用于结果合并
   oxy_space = [
       HttpLLM(name="merge_llm", ...),
       ParallelAgent(llm_model="merge_llm", ...)
   ]
   ```

### 部分失败处理

ParallelAgent 使用 `asyncio.gather()` 进行并行任务执行：
- 如果任何任务失败，整个并行执行都会失败
- 建议在各个工具/代理中实现适当的错误处理
- 考虑自定义实现包含 `return_exceptions=True`

## 使用场景

### 适用场景

1. **多专家咨询**：多个专家同时分析同一问题
2. **多维度分析**：从技术、商业、风险等多个角度进行评估
3. **对比评估**：并行比较多个解决方案或选项
4. **增强决策**：通过多元化视角提高决策质量

### 不适用场景

1. **顺序依赖**：后续任务依赖于前面任务的结果
2. **资源竞争**：多个任务竞争相同的有限资源
3. **简单查询**：单维度的简单问题
4. **实时交互**：需要快速响应的场景

## Related Links

- [ParallelAgent 主文档](/docs/agents-parallel) - 概述和使用指南
- [ChatAgent API](/oxyapi/agents-chat-api) - 基础聊天代理
- [ReActAgent API](/oxyapi/agents-react-api) - 推理代理
- [ParallelFlow API](/oxyapi/flows-parallel-api) - 并行流 API
