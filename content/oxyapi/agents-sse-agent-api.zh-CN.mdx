---
title: SSEOxyAgent API 参考
description: SSEOxyAgent 类的完整 API 参考文档，包括构造函数参数、SSE 通信方法和远程代理集成
icon: Radio
---

## 类概述

```python
from oxygent.oxy import SSEOxyGent

class SSEOxyGent(RemoteAgent):
    """通过服务器发送事件（SSE）协议与远程服务通信的代理。

    此代理作为基础代理，旨在提供与远程服务通信的功能。
    不同的代理通过 SSE 协议与远程服务交互，接收 OxyRequest 对象
    并在完成通信任务后返回 OxyResponse 对象。
    """
```

SSEOxyGent 继承自 `RemoteAgent`，专门设计用于处理与远程服务的 SSE 通信。它支持实时数据流、事件处理和调用栈共享等高级功能。

## 构造函数

### SSEOxyGent()

```python
SSEOxyGent(
    name: str,
    desc: str,
    server_url: str,
    is_share_call_stack: bool = True,
    **kwargs
)
```

#### 参数

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `name` | `str` | 必需 | 用于标识和调用的代理名称 |
| `desc` | `str` | 必需 | 解释代理功能的描述 |
| `server_url` | `str` | 必需 | 远程代理服务器 URL（必须以 http:// 或 https:// 开头） |
| `is_share_call_stack` | `bool` | `True` | 是否与远程代理共享调用栈信息 |

#### 继承参数（来自 RemoteAgent）

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `org` | `dict` | `{}` | 从远程系统检索的组织结构 |

#### 继承参数（来自 BaseAgent）

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `category` | `str` | `"agent"` | 工具/代理类别 |
| `input_schema` | `dict[str, Any]` | 配置默认值 | 输入参数模式 |

#### 继承参数（来自 BaseFlow）

|参数|类型|默认值|描述|
|-----------|------|---------|-------------|
| `is_master` | `bool` | `False` | 此代理是否为主代理 |
| `timeout` | `int` | `300` | 执行超时时间（秒） |
| `func_process_input` | `可选[Callable]` | `None` | 输入处理函数 |
| `func_process_output` | `可选[Callable]` | `None` | 输出处理函数 |

## 核心属性

### is_share_call_stack

```python
is_share_call_stack: bool = Field(
    True,
    description="是否与代理共享调用栈。"
)
```

控制是否与远程服务共享调用栈信息的布尔属性。

#### 机制

- **`True`（默认）**：共享调用栈信息
  - 保留调用栈和遍历的节点 ID
  - 远程服务可以理解完整的调用路径
  - 有助于调试和请求流程跟踪

- **`False`**：不共享调用栈信息
  - 移除调用栈和节点 ID 信息
  - 将调用者设置为 "user"
  - 保护隐私和安全，简化数据传输

#### 使用场景

|设置|适用场景|优势|劣势|
|---------|-------------------|------------|---------------|
| `True` | 调试、跟踪、复杂工作流 | 完整上下文，易于调试 | 数据传输量大，可能泄露信息 |
| `False` | 隐私保护、简单查询 | 数据精简，隐私保护 | 缺少上下文，调试困难 |

## 方法

### init()

```python
async def init(self) -> None
```

建立与远程服务连接并检索组织结构的异步初始化方法。

#### 执行流程

1. **调用父类初始化**：执行 RemoteAgent 初始化
2. **建立 HTTP 连接**：使用 httpx.AsyncClient 连接到远程服务
3. **获取组织信息**：从 `/get_organization` 端点检索组织结构
4. **存储组织数据**：将组织信息存储在 `self.org` 中

#### 异常处理

- 网络连接失败
- 远程服务不可用
- 组织信息格式错误

### _execute()

```python
async def _execute(self, oxy_request: OxyRequest) -> OxyResponse
```

执行 SSE 通信的核心方法。

#### 参数

|参数|类型|描述|
|-----------|------|-------------|
| `oxy_request` | `OxyRequest` | 包含查询和上下文信息的请求对象 |

#### 返回值

|类型|描述|
|------|-------------|
| `OxyResponse` | 包含远程代理响应的结果对象 |

#### 执行流程

1. **构建请求载荷**
   - 序列化 OxyRequest 对象
   - 将调用者类别更新为 "user"
   - 根据 `is_share_call_stack` 处理调用栈信息

2. **建立 SSE 连接**
   - 设置 SSE 特定的 HTTP 头
   - 向 `/sse/chat` 端点发送 POST 请求
   - 建立持久连接

3. **处理 SSE 数据流**
   - 逐行读取 SSE 数据
   - 解析带有 `data:` 前缀的消息
   - 处理不同的事件类型

4. **事件类型处理**
   - `"answer"`：提取最终答案
   - `"tool_call"`：处理工具调用事件
   - `"observation"`：处理观察结果
   - `"done"`：终止连接
   - 其他类型：直接转发

5. **返回结果**
   - 构造 OxyResponse 对象
   - 设置状态为 COMPLETED
   - 返回最终答案

#### SSE Data Format

```
data: {"type": "answer", "content": "This is the answer"}
data: {"type": "tool_call", "content": {...}}
data: {"type": "observation", "content": {...}}
data: done
```

### get_org()

```python
def get_org(self) -> list
```

获取标记为远程的组织结构副本。

#### 返回值

|类型|描述|
|------|-------------|
| `list` | 标记为 `is_remote=True` 的组织结构列表 |

#### 功能

- 创建组织结构的深度副本
- 为所有节点添加 `is_remote=True` 标记
- 递归处理嵌套的子节点

### 继承方法

#### 来自 RemoteAgent

- `check_protocol()` - 验证服务器 URL 协议

#### 来自 BaseAgent

- `_pre_process()` - 预处理请求
- `_pre_save_data()` - 保存跟踪数据

#### 来自 BaseFlow

- `call()` - 执行代理
- `set_mas()` - 设置 MAS 引用

## 使用示例

### 基础 SSE 代理

```python
from oxygent import MAS, oxy
from oxygent.utils.env_utils import get_env_var

oxy_space = [
    oxy.HttpLLM(
        name="default_llm",
        api_key=get_env_var("DEFAULT_LLM_API_KEY"),
        base_url=get_env_var("DEFAULT_LLM_BASE_URL"),
        model_name=get_env_var("DEFAULT_LLM_MODEL_NAME"),
    ),
    oxy.SSEOxyGent(
        name="remote_agent",
        desc="远程 SSE 代理",
        server_url="http://localhost:8082",
        is_share_call_stack=True,
    )
]

async def main():
    async with MAS(oxy_space=oxy_space) as mas:
        result = await mas.call(
            callee="remote_agent",
            arguments={"query": "Hello from SSE client"}
        )
        print(result.output)
```

### 不共享调用栈

```python
oxy.SSEOxyGent(
    name="private_agent",
    desc="隐私保护的远程代理",
    server_url="https://secure-service.example.com",
    is_share_call_stack=False,  # 不共享调用栈
)
```

### 在工作流中使用

```python
from oxygent import OxyRequest

async def workflow(oxy_request: OxyRequest):
    """集成 SSE 代理的工作流函数"""

    # 获取当前时间
    time_response = await oxy_request.call(
        callee="time_agent",  # SSE 时间代理
        arguments={"query": "What time is it now?"}
    )

    # 处理数学计算
    if "calculate" in oxy_request.get_query():
        calc_response = await oxy_request.call(
            callee="calc_agent",  # SSE 计算代理
            arguments={"query": oxy_request.get_query()}
        )
        return f"Time: {time_response.output}, Calculation result: {calc_response.output}"

    return f"Current time: {time_response.output}"

oxy_space = [
    oxy.HttpLLM(name="default_llm", ...),

    # 远程时间服务
    oxy.SSEOxyGent(
        name="time_agent",
        desc="时间查询代理",
        server_url="http://time-service:8082",
    ),

    # 远程计算服务
    oxy.SSEOxyGent(
        name="calc_agent",
        desc="计算代理",
        server_url="http://calc-service:8083",
    ),

    # 工作流代理
    oxy.WorkflowAgent(
        name="main_agent",
        desc="主工作流代理",
        func_workflow=workflow,
        llm_model="default_llm",
        is_master=True,
    ),
]
```

### 多服务集成

```python
# 创建连接到不同服务的多个 SSE 代理
services = [
    {"name": "nlp_service", "url": "http://nlp:8080", "desc": "自然语言处理服务"},
    {"name": "vision_service", "url": "http://vision:8081", "desc": "计算机视觉服务"},
    {"name": "search_service", "url": "http://search:8082", "desc": "搜索服务"},
]

oxy_space = [oxy.HttpLLM(name="default_llm", ...)]

for service in services:
    oxy_space.append(
        oxy.SSEOxyGent(
            name=service["name"],
            desc=service["desc"],
            server_url=service["url"],
            is_share_call_stack=True,
        )
    )

# 并行调用多个服务
oxy_space.append(
    oxy.ParallelAgent(
        name="multi_service_agent",
        desc="多服务并行处理",
        llm_model="default_llm",
        permitted_tool_name_list=["nlp_service", "vision_service", "search_service"],
        is_master=True,
    )
)
```

## SSE 协议详情

### SSE 基础

服务器发送事件（SSE）是 HTML5 规范的一部分，提供服务器到客户端的单向实时数据更新技术。

#### 特性

- **单向通信**：服务器向客户端推送数据
- **持久连接**：维持长连接以进行实时更新
- **自动重连**：连接断开时自动重新连接
- **事件驱动**：基于事件的数据传输

#### HTTP 头

```python
headers = {
    "Accept": "text/event-stream",
    "Content-Type": "application/json",
}
```

### 数据格式

SSE 数据以特定格式传输：

```
data: {"type": "answer", "content": "Response content"}

data: {"type": "tool_call", "content": {"caller": "agent1", "callee": "tool1"}}

data: {"type": "observation", "content": {"result": "Execution result"}}

data: done
```

### 事件类型

|事件类型|描述|处理方法|
|------------|-------------|-------------------|
| `answer` | 最终答案 | 提取内容作为响应 |
| `tool_call` | 工具调用 | 转发到本地 MAS |
| `observation` | 观察结果 | 转发到本地 MAS |
| `done` | 连接结束 | 终止 SSE 连接 |
| 其他 | 自定义事件 | 直接转发 |

## 配置选项

### 连接配置

- `server_url`: 远程服务器 URL
- `timeout`: 连接超时时间
- HTTP 头配置

### 调用栈配置

- `is_share_call_stack`: 是否共享调用栈
- 调用栈处理策略
- 隐私保护设置

### 错误处理配置

- 重连策略
- 超时处理
- 异常恢复

## 性能考虑

### 连接管理

1. **连接复用**：合理管理 SSE 连接
2. **超时设置**：设置合适的超时值
3. **资源清理**：及时释放连接资源

### 数据传输

1. **数据压缩**：减少传输数据量
2. **批量处理**：批量处理多个事件
3. **缓存策略**：缓存常见响应

### 错误恢复

1. **自动重连**：实现自动重连机制
2. **降级策略**：连接失败时的降级处理
3. **监控告警**：监控连接状态和性能

## 错误处理

### 常见错误

1. **连接失败**
   ```python
   # 检查服务器 URL 和网络连接
   try:
       async with httpx.AsyncClient() as client:
           response = await client.get(f"{server_url}/health")
   except httpx.ConnectError:
       logger.error("无法连接到远程服务器")
   ```

2. **SSE 数据格式错误**
   ```python
   try:
       data = json.loads(sse_data)
   except json.JSONDecodeError:
       logger.error(f"无效的 SSE 数据格式: {sse_data}")
   ```

3. **超时处理**
   ```python
   async with asyncio.timeout(30):  # 30 秒超时
       async with session.post(url, data=payload) as resp:
           # 处理 SSE 流
   ```

### 错误恢复

1. **重连机制**
   ```python
   max_retries = 3
   for attempt in range(max_retries):
       try:
           return await self._execute(oxy_request)
       except Exception as e:
           if attempt == max_retries - 1:
               raise
           await asyncio.sleep(2 ** attempt)  # 指数退避
   ```

2. **降级处理**
   ```python
   try:
       return await sse_agent.call(arguments)
   except SSEConnectionError:
       # 降级到本地处理
       return await local_agent.call(arguments)
   ```

## 安全考虑

### 数据保护

1. **HTTPS 连接**：使用 HTTPS 保护数据传输
2. **调用栈隐私**：谨慎共享调用栈信息
3. **输入验证**：验证远程服务响应

### 访问控制

1. **身份认证**：实现适当的身份认证机制
2. **授权控制**：控制对远程服务的访问
3. **审计日志**：记录所有远程调用

## 最佳实践

### 设计原则

1. **服务分离**：将不同功能分离到不同的远程服务
2. **无状态设计**：远程服务应该是无状态的
3. **幂等性**：确保操作的幂等性
4. **容错性**：设计容错和恢复机制

### 部署建议

1. **负载均衡**：使用负载均衡分发请求
2. **健康检查**：实现服务健康检查
3. **监控告警**：监控服务状态和性能
4. **版本管理**：管理服务版本和兼容性

### 调试技巧

1. **日志记录**：详细记录 SSE 通信日志
2. **事件跟踪**：跟踪完整的事件流
3. **性能分析**：分析通信性能和瓶颈
4. **测试工具**：使用专门的 SSE 测试工具

## 相关链接

- [SSEOxyAgent 主文档](/docs/agents-sse-agent) - 概述和使用指南
- [WorkflowAgent API](/oxyapi/agents-workflow-api) - 工作流代理集成
- [ParallelAgent API](/oxyapi/agents-parallel-api) - 并行代理 API
- [Context 文档](/docs/context) - 上下文管理系统
