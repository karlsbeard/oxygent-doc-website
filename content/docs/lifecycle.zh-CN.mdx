---
title: ç”Ÿå‘½å‘¨æœŸç®¡ç†
description: ç†è§£ OxyGent çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸã€çŠ¶æ€ç®¡ç†å’Œèµ„æºæ¸…ç†æ¨¡å¼
icon: LifeBuoy
---

OxyGent å®ç°äº†ä¸€ä¸ªå…¨é¢çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿï¼Œç®¡ç†ç»„ä»¶ï¼ˆæ™ºèƒ½ä½“ã€å·¥å…·ã€æµç¨‹ï¼‰å¦‚ä½•åˆå§‹åŒ–ã€æ‰§è¡Œå’Œæ¸…ç†ã€‚ç†è§£è¿™ä¸ªç”Ÿå‘½å‘¨æœŸå¯¹äºæ„å»ºå¯é ã€èµ„æºé«˜æ•ˆçš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿè‡³å…³é‡è¦ã€‚

## æ¦‚è¿°

OxyGent ç”Ÿå‘½å‘¨æœŸç³»ç»Ÿåœ¨ä¸¤ä¸ªä¸»è¦çº§åˆ«è¿è¡Œï¼š

1. **MASï¼ˆå¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼‰ç”Ÿå‘½å‘¨æœŸ**ï¼šåº”ç”¨ç¨‹åºçº§åˆå§‹åŒ–å’Œæ¸…ç†
2. **ç»„ä»¶æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ**ï¼šæ™ºèƒ½ä½“å’Œå·¥å…·çš„è¯·æ±‚çº§å¤„ç†

### å…³é”®ç‰¹æ€§

- **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šä½¿ç”¨ `async with` è‡ªåŠ¨è®¾ç½®å’Œæ¸…ç†èµ„æº
- **ç»“æ„åŒ–æ‰§è¡Œæµç¨‹**ï¼šé¢„å¤„ç† â†’ æ‰§è¡Œ â†’ åå¤„ç†é’©å­
- **çŠ¶æ€è·Ÿè¸ª**ï¼šç”¨äºç›‘æ§æ‰§è¡Œçš„å…¨é¢çŠ¶æ€ç®¡ç†
- **èµ„æºæ¸…ç†**ï¼šå³ä½¿å‘ç”Ÿé”™è¯¯ä¹Ÿä¿è¯æ¸…ç†
- **æ•°æ®åº“æŒä¹…åŒ–**ï¼šè‡ªåŠ¨ä¿å­˜è¿½è¸ªå’Œæ‰§è¡Œå†å²

### ç»„ä»¶çŠ¶æ€

OxyGent é€šè¿‡`OxyState` æšä¸¾è·Ÿè¸ªæ‰§è¡ŒçŠ¶æ€ï¼š

| çŠ¶æ€ | æè¿° | ä½•æ—¶åº”ç”¨ |
|-------|-------------|--------------|
| `CREATED` | ç»„ä»¶å·²å®ä¾‹åŒ–ä½†æœªå¯åŠ¨ | åˆå§‹çŠ¶æ€ |
| `RUNNING` | å½“å‰æ­£åœ¨æ‰§è¡Œ | æ‰§è¡ŒæœŸé—´ |
| `COMPLETED` | æˆåŠŸå®Œæˆ | æ­£å¸¸å®Œæˆ |
| `FAILED` | æ‰§è¡Œé”™è¯¯å‘ç”Ÿ | æŠ›å‡ºå¼‚å¸¸ |
| `PAUSED` | ä¸´æ—¶æš‚åœ | æ‰‹åŠ¨æš‚åœ |
| `SKIPPED` | æœªæ‰§è¡Œï¼ˆæ¡ä»¶æ€§ï¼‰| å·¥ä½œæµè·³è¿‡ |
| `CANCELED` | å®Œæˆå‰ä¸­æ­¢ | ç”¨æˆ·å–æ¶ˆ |

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ MAS ç”Ÿå‘½å‘¨æœŸ

MAS ç”Ÿå‘½å‘¨æœŸé€šè¿‡ Python çš„å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®ç®¡ç†ï¼š

```python
import asyncio
from oxygent import MAS, oxy
from oxygent.utils.env_utils import get_env_var

oxy_space = [
 oxy.HttpLLM(
 name="default_llm",
 api_key=get_env_var("DEFAULT_LLM_API_KEY"),
 base_url=get_env_var("DEFAULT_LLM_BASE_URL"),
 model_name=get_env_var("DEFAULT_LLM_MODEL_NAME"),
 ),
 oxy.ReActAgent(
 name="assistant",
 is_master=True,
 llm_model="default_llm",
 ),
]

async def main():
 # __aenter__: Initialization phase
 async with MAS(oxy_space=oxy_space) as mas:
 # MAS is fully initialized here
 # - All components registered
 # - Databases connected
 # - Agent organization built

 result = await mas.call(
 callee="assistant",
 arguments={"messages": [{"role": "user", "content": "Hello"}]}
 )
 print(result.output)

 # __aexit__: Cleanup phase (automatic)
 # - Close database connections
 # - Wait for background tasks
 # - Release resources

if __name__ == "__main__":
 asyncio.run(main())
```

### ç»„ä»¶æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ

æ¯ä¸ªç»„ä»¶çš„æ‰§è¡Œéƒ½éµå¾ªå¸¦æœ‰é’©å­çš„ç»“æ„åŒ–æµç¨‹ï¼š

```python
from oxygent.oxy import LocalAgent
from oxygent.schemas import OxyRequest, OxyResponse

class CustomAgent(LocalAgent):
    async def _pre_process(self, oxy_request: OxyRequest) -> OxyRequest:
        """é¢„å¤„ç†é’©å­ï¼šåœ¨æ‰§è¡Œå‰å‡†å¤‡è¯·æ±‚ã€‚"""
        # è®¿é—®çˆ¶ç±»é¢„å¤„ç†
        oxy_request = await super()._pre_process(oxy_request)

        # æ·»åŠ è‡ªå®šä¹‰é¢„å¤„ç†é€»è¾‘
        print(f"[PRE] æ­£åœ¨å¤„ç† {oxy_request.callee} çš„è¯·æ±‚")
        oxy_request.arguments["timestamp"] = "2025-10-29"

        return oxy_request

    async def _execute(self, oxy_request: OxyRequest) -> OxyResponse:
        """ä¸»æ‰§è¡Œé€»è¾‘ã€‚"""
        # æ‚¨çš„æ™ºèƒ½ä½“å®ç°
        user_query = oxy_request.arguments.get("messages", [])

        # å¤„ç†æŸ¥è¯¢
        result = f"å·²å¤„ç†ï¼š{user_query}"

        return OxyResponse(
            output=result,
            oxy_request=oxy_request
        )

    async def _post_process(self, oxy_response: OxyResponse) -> OxyResponse:
        """åå¤„ç†é’©å­ï¼šåœ¨æ‰§è¡Œåä¿®æ”¹å“åº”ã€‚"""
        # è®¿é—®çˆ¶ç±»åå¤„ç†
        oxy_response = await super()._post_process(oxy_response)

        # æ·»åŠ è‡ªå®šä¹‰åå¤„ç†é€»è¾‘
        print(f"[POST] å·²å®Œæˆï¼Œè¾“å‡ºé•¿åº¦ï¼š{len(oxy_response.output)}")

        return oxy_response
```

## MAS ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ

### é˜¶æ®µ 1ï¼šåˆå§‹åŒ–ï¼ˆ`__aenter__` / `init()`ï¼‰

è¿›å…¥ MAS ä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹æ­¥éª¤ï¼š

```
1. æ³¨å†Œ Oxy ç»„ä»¶
 â†“
2. åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
 - Elasticsearchï¼ˆè¿½è¸ªã€å†å²ï¼‰
 - Redisï¼ˆç¼“å­˜ã€é˜Ÿåˆ—ï¼‰
 - Vearchï¼ˆå‘é‡æœç´¢ï¼‰
 â†“
3. åˆå§‹åŒ–æ‰€æœ‰ Oxy å®ä¾‹
 - è°ƒç”¨æ¯ä¸ªç»„ä»¶çš„ init() æ–¹æ³•
 - æ‰§è¡Œä¾èµ–æ³¨å…¥
 â†“
4. ç¡®å®šä¸»æ™ºèƒ½ä½“
 - æŸ¥æ‰¾ is_master=True çš„æ™ºèƒ½ä½“
 - è®¾ç½®ä¸ºå…¥å£ç‚¹
 â†“
5. æ„å»ºæ™ºèƒ½ä½“ç»„ç»‡
 - åˆ›å»ºå±‚çº§ç»“æ„
 - å°†æ™ºèƒ½ä½“æ˜ å°„åˆ°å·¥å…·
 - æ˜¾ç¤ºç»„ç»‡æ ‘
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
async def init(self):
    """MAS åˆå§‹åŒ–åºåˆ—ã€‚"""
    # 1. æ˜¾ç¤ºæ¨ªå¹…
    self.show_banner()
    self.show_mas_info()

    # 2. æ³¨å†Œé»˜è®¤å’Œè‡ªå®šä¹‰ç»„ä»¶
    self.register_oxy_list(self.default_oxy_space)
    self.register_oxy_list(self.oxy_space)

    # 3. åˆå§‹åŒ–æ•°æ®åº“
    await self.init_db()

    # 4. åˆå§‹åŒ–æ‰€æœ‰ Oxy ç»„ä»¶
    await self.init_all_oxy()

    # 5. è®¾ç½®ä¸»æ™ºèƒ½ä½“
    await self.init_master_agent_name()

    # 6. æ„å»ºç»„ç»‡ç»“æ„
    await self.init_agent_organization()
```

### é˜¶æ®µ 2ï¼šæ‰§è¡Œï¼ˆè¿è¡Œæ—¶ï¼‰

åœ¨æ‰§è¡ŒæœŸé—´ï¼Œæ¯ä¸ªç»„ä»¶è¯·æ±‚æµç¨‹å¦‚ä¸‹ï¼š

```
ç”¨æˆ·/çˆ¶è¯·æ±‚
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _pre_process() â”‚ å‡†å¤‡è¯·æ±‚
â”‚ - åŠ è½½ä¸Šä¸‹æ–‡ â”‚
â”‚ - éªŒè¯è¾“å…¥ â”‚
â”‚ - è®¾ç½®èµ„æº â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _pre_save_data() â”‚ ä¿å­˜é¢„æ‰§è¡ŒçŠ¶æ€
â”‚ - å­˜å‚¨è¿½è¸ª â”‚
â”‚ - è®°å½•è¯·æ±‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _execute() â”‚ æ ¸å¿ƒé€»è¾‘
â”‚ - å¤„ç†è¯·æ±‚ â”‚
â”‚ - è°ƒç”¨å­æ™ºèƒ½ä½“ â”‚
â”‚ - ç”Ÿæˆå“åº” â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _post_process() â”‚ ä¿®æ”¹å“åº”
â”‚ - æ ¼å¼åŒ–è¾“å‡º â”‚
â”‚ - æ›´æ–°çŠ¶æ€ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _post_save_data() â”‚ ä¿å­˜ç»“æœ
â”‚ - å­˜å‚¨è¿½è¸ª â”‚
â”‚ - è®°å½•å“åº” â”‚
â”‚ - æ›´æ–°å†å² â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
è¿”å› OxyResponse
```

### é˜¶æ®µ 3ï¼šæ¸…ç†ï¼ˆ`__aexit__`ï¼‰

é€€å‡º MAS ä¸Šä¸‹æ–‡æ—¶ï¼š

```
1. ç­‰å¾…åå°ä»»åŠ¡
 - å®Œæˆæ‰€æœ‰å¼‚æ­¥æ“ä½œ
 - å®Œæˆæ•°æ®åº“å†™å…¥
 â†“
2. å…³é—­æ•°æ®åº“è¿æ¥
 - Elasticsearch ä¼˜é›…å…³é—­
 - Redis è¿æ¥æ¸…ç†
 â†“
3. æ¸…ç† MCP æœåŠ¡å™¨
 - åœæ­¢è¿è¡Œçš„ MCP è¿›ç¨‹
 - é‡Šæ”¾æ–‡ä»¶å¥æŸ„
 â†“
4. é‡Šæ”¾èµ„æº
 - æ¸…é™¤æ´»åŠ¨ä»»åŠ¡
 - é‡Šæ”¾å†…å­˜
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
async def __aexit__(self, exc_type, exc_val, exc_tb):
    """MAS æ¸…ç†åºåˆ—ã€‚"""
    # 1. ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡
    await asyncio.gather(*self.background_tasks)

    # 2. è®°å½•é€€å‡º
    logger.info("=" * 64)
    logger.info("ğŸª‚ OxyGent MAS åº”ç”¨ç¨‹åºé€€å‡º")
    logger.info("=" * 64)

    # 3. å…³é—­æ•°æ®åº“
    await self.es_client.close()
    await self.redis_client.close()

    # 4. æ¸…ç†æœåŠ¡å™¨
    await self.cleanup_servers()
```

## ç»„ä»¶æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ

### æ‰§è¡Œé’©å­

æ¯ä¸ªç»„ä»¶æ‰§è¡Œéƒ½æä¾›ç”¨äºè‡ªå®šä¹‰çš„é’©å­ï¼š

#### 1. `_pre_process(oxy_request)` â†’ `OxyRequest`

**ç”¨é€”**ï¼šåœ¨æ‰§è¡Œå‰å‡†å¤‡è¯·æ±‚

**å¸¸è§ç”¨é€”**ï¼š
- ä»æ•°æ®åº“åŠ è½½å†å²ä¸Šä¸‹æ–‡
- éªŒè¯è¾“å…¥å‚æ•°
- è®¾ç½®ä¸´æ—¶èµ„æº
- æ³¨å…¥é»˜è®¤å€¼

**ç¤ºä¾‹**ï¼š

```python
async def _pre_process(self, oxy_request: OxyRequest) -> OxyRequest:
    oxy_request = await super()._pre_process(oxy_request)

    # åŠ è½½å¯¹è¯å†å²
    if oxy_request.from_trace_id:
        history = await self.load_history(oxy_request.from_trace_id)
        oxy_request.shared_data["history"] = history

    # éªŒè¯å¿…å¡«å­—æ®µ
    if "query" not in oxy_request.arguments:
        raise ValueError("ç¼ºå°‘å¿…å¡«å­—æ®µï¼šquery")

    return oxy_request
```

#### 2. `_execute(oxy_request)` â†’ `OxyResponse`

**ç”¨é€”**ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘

**å¸¸è§ç”¨é€”**ï¼š
- å¤„ç†ç”¨æˆ·æŸ¥è¯¢
- è°ƒç”¨ LLM æˆ–å·¥å…·
- åè°ƒå­æ™ºèƒ½ä½“
- ç”Ÿæˆå“åº”

**ç¤ºä¾‹**ï¼š

```python
async def _execute(self, oxy_request: OxyRequest) -> OxyResponse:
    messages = oxy_request.arguments["messages"]

    # è°ƒç”¨ LLM
    llm = oxy_request.get_oxy("default_llm")
    response = await llm.call(messages=messages)

    return OxyResponse(
        output=response.output,
        oxy_request=oxy_request
    )
```

#### 3. `_post_process(oxy_response)` â†’ `OxyResponse`

**ç”¨é€”**ï¼šä¿®æ”¹æˆ–ä¸°å¯Œå“åº”

**å¸¸è§ç”¨é€”**ï¼š
- æ ¼å¼åŒ–è¾“å‡º
- æ·»åŠ å…ƒæ•°æ®
- æ›´æ–°å…±äº«çŠ¶æ€
- è®°å½•æŒ‡æ ‡

**ç¤ºä¾‹**ï¼š

```python
async def _post_process(self, oxy_response: OxyResponse) -> OxyResponse:
    oxy_response = await super()._post_process(oxy_response)

    # æ·»åŠ å…ƒæ•°æ®
    oxy_response.metadata = {
        "agent": self.name,
        "tokens": len(oxy_response.output.split()),
        "timestamp": get_format_time()
    }

    # ä¸ºä¸‹æ¸¸æ™ºèƒ½ä½“æ›´æ–°å…±äº«æ•°æ®
    oxy_response.oxy_request.shared_data["last_agent"] = self.name

    return oxy_response
```

### æ•°æ®æŒä¹…åŒ–é’©å­

#### `_pre_save_data(oxy_request)`

**ç”¨é€”**ï¼šåœ¨å¤„ç†å‰ä¿å­˜åˆå§‹è¿½è¸ª

**ä¿å­˜çš„å†…å®¹**ï¼š
- è¯·æ±‚ ID å’Œè¿½è¸ª ID
- è¾“å…¥å‚æ•°
- å…±äº«æ•°æ®å’Œç»„æ•°æ®
- æ—¶é—´æˆ³

**å­˜å‚¨ä½ç½®**ï¼šElasticsearch `{app_name}_trace` ç´¢å¼•

#### `_post_save_data(oxy_response)`

**ç”¨é€”**ï¼šç”¨ç»“æœæ›´æ–°è¿½è¸ª

**ä¿å­˜çš„å†…å®¹**ï¼š
- è¾“å‡ºå“åº”
- æ‰§è¡ŒçŠ¶æ€
- å¯¹è¯å†å²ï¼ˆå¯é€‰ï¼‰
- å®Œæˆæ—¶é—´æˆ³

## çŠ¶æ€ç®¡ç†

### çŠ¶æ€è½¬æ¢

ç»„ä»¶åœ¨æ‰§è¡ŒæœŸé—´è½¬æ¢çŠ¶æ€ï¼š

```
CREATED
 â†“ (å¼€å§‹æ‰§è¡Œ)
RUNNING
 â†“
 â”œâ”€ (æˆåŠŸ) â†’ COMPLETED
 â”œâ”€ (é”™è¯¯) â†’ FAILED
 â”œâ”€ (æš‚åœ) â†’ PAUSED
 â”œâ”€ (è·³è¿‡) â†’ SKIPPED
 â””â”€ (å–æ¶ˆ) â†’ CANCELED
```

### è¿½è¸ªçŠ¶æ€

é€šè¿‡è¯·æ±‚è®¿é—®ç»„ä»¶çŠ¶æ€ï¼š

```python
async def _execute(self, oxy_request: OxyRequest) -> OxyResponse:
    # ç»„ä»¶åœ¨è¿™é‡Œå¤„äº RUNNING çŠ¶æ€

    try:
        result = await self.process(oxy_request)
        # è‡ªåŠ¨è½¬æ¢ä¸º COMPLETED
        return OxyResponse(output=result, oxy_request=oxy_request)

    except Exception as e:
        # è‡ªåŠ¨è½¬æ¢ä¸º FAILED
        logger.error(f"æ‰§è¡Œå¤±è´¥ï¼š{e}")
        raise
```

## èµ„æºç®¡ç†

### æ•°æ®åº“è¿æ¥

OxyGent è‡ªåŠ¨ç®¡ç†æ•°æ®åº“ç”Ÿå‘½å‘¨æœŸï¼š

```python
# æ•°æ®åº“åœ¨ MAS.__aenter__ ä¸­åˆå§‹åŒ–
async with MAS(oxy_space=oxy_space) as mas:
    # Elasticsearchã€Redisã€Vearch å·²è¿æ¥

    # åœ¨æ‰§è¡ŒæœŸé—´ä½¿ç”¨æ•°æ®åº“
    result = await mas.es_client.search(...)

    # æ•°æ®åº“åœ¨ MAS.__aexit__ ä¸­å…³é—­
```

### åå°ä»»åŠ¡

æ­£ç¡®ç®¡ç†é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼š

```python
async def start_background_task(self):
    """å¯åŠ¨ç”± MAS è·Ÿè¸ªçš„åå°ä»»åŠ¡ã€‚"""
    task = asyncio.create_task(self.long_running_operation())
    self.mas.background_tasks.add(task)
    task.add_done_callback(self.mas.background_tasks.discard)
```

### MCP æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸ

MCP æœåŠ¡å™¨ç”± MAS ç®¡ç†ï¼š

```python
from oxygent.oxy.mcp_tools import StdioMCPClient

mcp_client = StdioMCPClient(
    name="mcp_filesystem",
    command="npx",
    args=["-y", "@modelcontextprotocol/server-filesystem", "/tmp"]
)

# æœåŠ¡å™¨åœ¨ MAS åˆå§‹åŒ–æ—¶å¯åŠ¨
async with MAS(oxy_space=[mcp_client, ...]) as mas:
    # ä½¿ç”¨ MCP å·¥å…·
    result = await mas.call(...)

    # æœåŠ¡å™¨åœ¨ MAS é€€å‡ºæ—¶åœæ­¢
```

## ç¤ºä¾‹

å®é™…ç¤ºä¾‹å’Œä½¿ç”¨æ¨¡å¼ï¼Œè¯·å‚è€ƒï¼š

- [åŸºç¡€ç”Ÿå‘½å‘¨æœŸ](/examples/core-concepts/lifecycle-basics) - ç†è§£ MAS ç”Ÿå‘½å‘¨æœŸ
- [è‡ªå®šä¹‰é’©å­](/examples/core-concepts/custom-hooks) - å®ç°æ‰§è¡Œé’©å­
- [èµ„æºç®¡ç†](/examples/core-concepts/resource-management) - ç®¡ç†æ•°æ®åº“å’Œè¿æ¥
- [çŠ¶æ€è¿½è¸ª](/examples/core-concepts/state-tracking) - ç›‘æ§ç»„ä»¶çŠ¶æ€

æŸ¥çœ‹ [ç¤ºä¾‹åº“](/examples) ä¸­çš„æ‰€æœ‰ç¤ºä¾‹ã€‚

## æœ€ä½³å®è·µ

### 1. å§‹ç»ˆä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
# âœ… å¥½ï¼šè‡ªåŠ¨æ¸…ç†
async with MAS(oxy_space=oxy_space) as mas:
    result = await mas.call(...)

# âŒ å·®ï¼šéœ€è¦æ‰‹åŠ¨æ¸…ç†
mas = await MAS.create(oxy_space=oxy_space)
result = await mas.call(...)
await mas.cleanup()  # å®¹æ˜“å¿˜è®°ï¼
```

### 2. è°ƒç”¨çˆ¶ç±»é’©å­

```python
# âœ… å¥½ï¼šä¿ç•™çˆ¶ç±»è¡Œä¸º
async def _pre_process(self, oxy_request: OxyRequest) -> OxyRequest:
    oxy_request = await super()._pre_process(oxy_request)
    # æ·»åŠ è‡ªå®šä¹‰é€»è¾‘
    return oxy_request

# âŒ å·®ï¼šè·³è¿‡çˆ¶ç±»å¤„ç†
async def _pre_process(self, oxy_request: OxyRequest) -> OxyRequest:
    # ä»…è‡ªå®šä¹‰é€»è¾‘
    return oxy_request
```

### 3. ä¼˜é›…åœ°å¤„ç†é”™è¯¯

```python
async def _execute(self, oxy_request: OxyRequest) -> OxyResponse:
    try:
        result = await self.risky_operation()
        return OxyResponse(output=result, oxy_request=oxy_request)

    except SpecificError as e:
        logger.error(f"å·²çŸ¥é”™è¯¯ï¼š{e}")
        # è¿”å›åå¤‡å“åº”è€Œä¸æ˜¯å´©æºƒ
        return OxyResponse(
            output="æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",
            oxy_request=oxy_request,
            state=OxyState.FAILED
        )

    finally:
        # æ¸…ç†ä¸´æ—¶èµ„æº
        await self.cleanup_temp_files()
```

### 4. è¿½è¸ªåå°ä»»åŠ¡

```python
# âœ… å¥½ï¼šæ³¨å†Œåå°ä»»åŠ¡
async def start_monitoring(self):
    task = asyncio.create_task(self.monitor_loop())
    self.mas.background_tasks.add(task)
    task.add_done_callback(self.mas.background_tasks.discard)

# âŒ å·®ï¼šå­¤ç«‹çš„åå°ä»»åŠ¡
async def start_monitoring(self):
    asyncio.create_task(self.monitor_loop())  # æœªè¿½è¸ªï¼
```

## ç›¸å…³é“¾æ¥

- [MASï¼ˆå¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼‰](/docs/mas) - MAS æ¶æ„å’Œ API
- [å››çº§ä½œç”¨åŸŸç³»ç»Ÿ](/docs/four-scope) - ç†è§£æ•°æ®ä½œç”¨åŸŸ
- [é…ç½®](/docs/configuration) - å…¨å±€é…ç½®é€‰é¡¹
- [ReAct æ™ºèƒ½ä½“](/docs/agents-react) - æ™ºèƒ½ä½“å®ç°ç¤ºä¾‹
